@using DailyLoan.Library.Status
<style>
    .container {
        overflow-x: auto;
    }
</style>
<div class="card-body bg-light p-3 rounded ">
    <div style="display:inline-block;" class="input-group mb-3 input-group-sm justify-content-center">
        <div class="row">
<!--
    <div class="col-md-4 pb-3">
        <label for="month" class="form-label">ข้อมูลประจำเดือน</label>
        <select class="form-select form-select-sm" id="month" name="month">
            <option value="1">มกราคม(1)</option>
            <option value="2">กุมภาพันธ์(2)</option>
            <option value="3">มีนาคม(3)</option>
            <option value="4">เมษายน(4)</option>
            <option value="5">พฤษภาคม(5)</option>
            <option value="6">มิถุนายน(6)</option>
            <option value="7">กรกฎาคม(7)</option>
            <option value="8">สิงหาคม(8)</option>
            <option value="9">กันยายน(9)</option>
            <option value="10">ตุลาคม(10)</option>
            <option value="11">พฤศจิกายน(11)</option>
            <option value="12">ธันวาคม(12)</option>
        </select>
    </div>
    <div class="col-md-4 pb-3">
        <label for="year" class="form-label">ปี</label>
        <select class="form-select form-select-sm" id="year" name="year">
        </select>
    </div>
-->
            <div class="col-md-8 pb-3">
                <label for="startdate" class="form-label" style="width:100%;">ข้อมูลประจำวันที่</label>
                <input type="date" class="form-control" style="display:inline-block;width:36%;" timezone="en-us" id="startdate" placeholder="dd/MM/yyyy">
                &nbsp;&nbsp;ถึง&nbsp;&nbsp;<input type="date" class="form-control" style="display: inline-block; width: 36%;" timezone="en-us" id="enddate" placeholder="dd/MM/yyyy">
            </div>
            @if (ViewBag.UserAccess == StatusUserAccess.UserAccess_Superadmin.ToString())
            {
                <div class="col-md-4 pb-3">
                    <label for="house" class="form-label">บ้าน</label>
                    <select class="form-select form-select-sm" id="house" name="house">
                        @foreach (var item in ViewBag.House)
                        {
                            <option value="@item.Id">@item.HouseName</option>
                        }
                    </select>
                </div>
            }
        </div>
        <!-- -->
        <button type="button" class="btn btn-info btn-sm" onclick="search()">
            <i class="fa fa-search"></i>
            ดูข้อมูล
        </button>
        <button type="button" class="btn btn-success btn-sm" onclick="showprint();" id="btnprint">
            <i class="fa fa-print" aria-hidden="true"></i>
            ปริ้น
        </button>
    </div>
</div>
<div class="card-body bg-light p-3 rounded ">
    <div class="container-fluid" id="inputpane">
        <div class="row">
            <table id="table" class="table table-hover" style="text-align: center; vertical-align: middle;">
                <thead><tr id="tablehead"></tr></thead>
                <tbody id="tablebody"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
    var root = '@Url.Content("~/")';
    root = (root == '/' ? "" : root);
    var useraccess = '@ViewBag.UserAccess';
    var superadmin = '@StatusUserAccess.UserAccess_Superadmin';
    var admin = '@StatusUserAccess.UserAccess_Admin';
    function dateStr(dat) {
        return dat.getFullYear() + '-' + ('0' + (dat.getMonth() + 1)).slice(-2) + '-' + ('0' + (dat.getDate())).slice(-2)
    }
    function dateData(str) {
        var arr = str.split('-');
        return new Date(parseInt(arr[0]), parseInt(arr[1]) - 1, parseInt(arr[2]))
    }
    function search() {
        $('#inputpane').show();
        $('#btnprint').show();
        $('#tablehead').empty();
        $('#tablebody').empty();
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        let req = new XMLHttpRequest();
        let formData = new FormData();
        formData.append("hid", $("#house").val());
        formData.append("start", ($("#startdate").val()));
        formData.append("end", ($("#enddate").val()));
        req.open("POST", '/GetMonthlyReport');
        req.send(formData);
        req.onload = function () {
            if (req.readyState == 4 && req.status == 200) {
                var data = JSON.parse(req.responseText);
                if (data.customerlines.length == 0) {
                    $('#tablehead').append('<th>ไม่มีข้อมูล</th>');
                }
                else {
                    var header = '<th colspan="2">หัวข้อ</th>';
                    var cus = [
                        '<tr><th rowspan="6">ลูกค้า</th><td>เงินที่จ่ายลูกค้า</td>',
                        '<tr><td>ยอดที่ต้องเก็บ</td>',
                        '<tr><td>ยอดที่เก็บได้</td>',
                        '<tr><td>ยอดเก็บได้เพิ่มเติม</td>',
                        '<tr><td>ยอดเสีย</td>',
                        '<tr style="background-color:#16B200;border-bottom:solid 3px black;color:#fff;"><td>กำไร / ขาดทุน</td>',
                    ];
                    var employ = [
                        '<tr><th rowspan="5">พนักงาน</th><td>เบี้ยเลี้ยง</td>',
                        '<tr><td>ค่าหัว</td>',
                        '<tr><td>เงินเดือนคนเก็บรวม</td>',
                        '<tr><td>เงินเดือน 2</td>',
                        '<tr><td>เงินเดือนออฟฟิศ</td><td colspan="' + data.customerlines.length + '" style="background-color:#d8d8d8;"></td><td>' + data.salary + '</td></tr>',
                        '<tr style="background-color:#16B200;border-bottom:solid 3px black;color:#fff;"><td>รวมเงินเดือน</td>',
                    ];
                    var clex = [
                        '<tr><th rowspan="7">ค่าใช้จ่ายทั่วไป</th><td>ค่าบำรุงรักษารถ</td>',
                        '<tr><td>น้ำมัน</td>',
                        '<tr><td>เติมเงิน</td>',
                        '<tr><td>ตำรวจ</td>',
                        '<tr><td>โดนจับ</td>',
                        '<tr><td>อื่นๆ</td>',
                        '<tr style="border-bottom:solid 3px black;"><td>รวมค่าใช้จ่ายทั่วไป</td>',
                    ];
                    var hex = [
                        '<tr><th rowspan="10">ค่าใช้จ่ายบ้าน</th><td>ค่าเช่าบ้าน</td><td rowspan="10" colspan="' + data.customerlines.length + '" style="background-color:#d8d8d8;"></td><td>' + data.houserent + '</td></tr>',
                        '<tr><td>ค่าน้ำ</td><td>' + data.water + '</td></tr>',
                        '<tr><td>ค่าไฟ</td><td>' + data.electric + '</td></tr>',
                        '<tr><td>ค่าเน็ต</td><td>' + data.internet + '</td></tr>',
                        '<tr><td>ค่ากระดาษ / หมึก</td><td>' + data.paperink + '</td></tr>',
                        '<tr><td>ค่าของไหว้</td><td>' + data.godfee + '</td></tr>',
                        '<tr><td>ค่างานเลี้ยง</td><td>' + data.banquet + '</td></tr>',
                        '<tr><td>ค่าเช่ารถ / ค่างวด</td><td>' + data.vehicle + '</td></tr>',
                        '<tr><td>อื่นๆ</td><td>' + data.other + '</td></tr>',
                        '<tr style="border-bottom:solid 3px black;"><td>รวมค่าใช้จ่ายบ้าน</td><td>' + data.totalhouseexpenses + '</td></tr>',
                    ];
                    var summary = [
                        '<tr><th rowspan="10">สรุป</th><td>กำไร / ขาดทุน</td>',
                        '<tr><td>ยอดที่เก็บได้</td>',
                        '<tr><td>ยอดเสีย</td>',
                        '<tr><td>สรุปยอดตัด</td>',
                        '<tr><td>สรุปยอดเปิด</td>',
                        '<tr><td>สรุปยอดปิด</td>',
                        '<tr><td>รวมค่าใช้จ่ายทั่วไป</td>',
                        '<tr><td>รวมค่าใช้จ่ายบ้าน</td><td colspan="' + data.customerlines.length + '" style="background-color:#d8d8d8;"></td><td>' + data.totalhouseexpenses + '</td></tr>',
                        '<tr><td>รวมจ่ายพนักงาน</td>',
                        '<tr style="background-color:#16B200;border-bottom:solid 3px black;color:#fff;"><th>คงเหลือสุทธิ</th>',
                    ];
                    var allsum = [0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0,
                        0, 0];
                    for (var i = 0; i < data.customerlines.length; i++) {
                        header += '<th>' + data.customerlines[i].name + '</th>';
                        cus[0] += '<td>' + data.customerlines[i].paytocustomer + '</td>'; allsum[0] += data.customerlines[i].paytocustomer;
                        cus[1] += '<td>' + data.customerlines[i].mustcollect + '</td>'; allsum[1] += data.customerlines[i].mustcollect;
                        cus[2] += '<td>' + data.customerlines[i].collect + '</td>'; allsum[2] += data.customerlines[i].collect;
                        cus[3] += '<td>' + data.customerlines[i].otherincome + '</td>'; allsum[3] += data.customerlines[i].otherincome;
                        cus[4] += '<td>' + data.customerlines[i].loss + '</td>'; allsum[4] += data.customerlines[i].loss;
                        cus[5] += '<td>' + data.customerlines[i].profit + '</td>'; allsum[5] += data.customerlines[i].profit;
                        employ[0] += '<td>' + data.customerlines[i].allowance + '</td>'; allsum[6] += data.customerlines[i].allowance;
                        employ[1] += '<td>' + data.customerlines[i].bounty + '</td>'; allsum[7] += data.customerlines[i].bounty;
                        employ[2] += '<td>' + data.customerlines[i].salary1 + '</td>'; allsum[8] += data.customerlines[i].salary1;
                        employ[3] += '<td>' + data.customerlines[i].salary2 + '</td>'; allsum[9] += data.customerlines[i].salary2;
                        employ[5] += '<td>' + data.customerlines[i].totalemploy + '</td>'; allsum[11] += data.customerlines[i].totalemploy;
                        clex[0] += '<td>' + data.customerlines[i].bike + '</td>'; allsum[12] += data.customerlines[i].bike;
                        clex[1] += '<td>' + data.customerlines[i].gas + '</td>'; allsum[13] += data.customerlines[i].gas;
                        clex[2] += '<td>' + data.customerlines[i].topup + '</td>'; allsum[14] += data.customerlines[i].topup;
                        clex[3] += '<td>' + data.customerlines[i].police + '</td>'; allsum[15] += data.customerlines[i].police;
                        clex[4] += '<td>' + data.customerlines[i].caught + '</td>'; allsum[16] += data.customerlines[i].caught;
                        clex[5] += '<td>' + data.customerlines[i].other + '</td>'; allsum[17] += data.customerlines[i].other;
                        clex[6] += '<td>' + data.customerlines[i].totalexpenses + '</td>'; allsum[18] += data.customerlines[i].totalexpenses;
                        summary[0] += '<td>' + data.customerlines[i].profit + '</td>';
                        summary[1] += '<td>' + data.customerlines[i].collect + '</td>';
                        summary[2] += '<td>' + data.customerlines[i].loss + '</td>';
                        summary[3] += '<td>' + data.customerlines[i].cut + '</td>'; allsum[19] += data.customerlines[i].cut;
                        summary[4] += '<td>' + data.customerlines[i].open + '</td>'; allsum[20] += data.customerlines[i].open;
                        summary[5] += '<td>' + data.customerlines[i].close + '</td>'; allsum[21] += data.customerlines[i].close;
                        summary[6] += '<td>' + data.customerlines[i].totalexpenses + '</td>';
                        summary[8] += '<td>' + data.customerlines[i].totalemploy + '</td>';
                        summary[9] += '<th>' + (data.customerlines[i].grandtotal) + '</th>'; allsum[10] += data.customerlines[i].grandtotal;
                    }
                    header += '<th>ส่วนกลาง / ยอดรวม</th>';
                    cus[0] += '<td>' + allsum[0] + '</td></tr>';
                    cus[1] += '<td>' + allsum[1] + '</td></tr>';
                    cus[2] += '<td>' + allsum[2] + '</td></tr>';
                    cus[3] += '<td>' + allsum[3] + '</td></tr>';
                    cus[4] += '<td>' + allsum[4] + '</td></tr>';
                    cus[5] += '<td>' + allsum[5] + '</td></tr>';
                    employ[0] += '<td>' + allsum[6] + '</td></tr>';
                    employ[1] += '<td>' + allsum[7] + '</td></tr>';
                    employ[2] += '<td>' + allsum[8] + '</td></tr>';
                    employ[3] += '<td>' + allsum[9] + '</td></tr>';
                    employ[5] += '<td>' + (allsum[11] + data.salary) + '</td></tr>';
                    clex[0] += '<td>' + allsum[12] + '</td></tr>';
                    clex[1] += '<td>' + allsum[13] + '</td></tr>';
                    clex[2] += '<td>' + allsum[14] + '</td></tr>';
                    clex[3] += '<td>' + allsum[15] + '</td></tr>';
                    clex[4] += '<td>' + allsum[16] + '</td></tr>';
                    clex[5] += '<td>' + allsum[17] + '</td></tr>';
                    clex[6] += '<td>' + allsum[18] + '</td></tr>';
                    summary[0] += '<td>' + allsum[5] + '</td></tr>';
                    summary[1] += '<td>' + allsum[2] + '</td></tr>';
                    summary[2] += '<td>' + allsum[4] + '</td></tr>';
                    summary[3] += '<td>' + allsum[19] + '</td></tr>';
                    summary[4] += '<td>' + allsum[20] + '</td></tr>';
                    summary[5] += '<td>' + allsum[21] + '</td></tr>';
                    summary[6] += '<td>' + allsum[18] + '</td></tr>';
                    summary[8] += '<td>' + (allsum[11] + data.salary) + '</td></tr>';
                    summary[9] += '<th style="background-color:#0069B2;color:#fff;">' + (allsum[10] - data.salary - data.totalhouseexpenses) + '</th></tr>';

                    $('#tablehead').append(header);
                    $('#tablebody').append(cus[0]);
                    $('#tablebody').append(cus[1]);
                    $('#tablebody').append(cus[2]);
                    $('#tablebody').append(cus[3]);
                    $('#tablebody').append(cus[4]);
                    $('#tablebody').append(cus[5]);
                    $('#tablebody').append(employ[0]);
                    $('#tablebody').append(employ[1]);
                    $('#tablebody').append(employ[2]);
                    //$('#tablebody').append(employ[3]);
                    $('#tablebody').append(employ[4]);
                    $('#tablebody').append(employ[5]);
                    $('#tablebody').append(clex[0]);
                    $('#tablebody').append(clex[1]);
                    $('#tablebody').append(clex[2]);
                    $('#tablebody').append(clex[3]);
                    $('#tablebody').append(clex[4]);
                    $('#tablebody').append(clex[5]);
                    $('#tablebody').append(clex[6]);
                    $('#tablebody').append(hex[0]);
                    $('#tablebody').append(hex[1]);
                    $('#tablebody').append(hex[2]);
                    $('#tablebody').append(hex[3]);
                    $('#tablebody').append(hex[4]);
                    $('#tablebody').append(hex[5]);
                    $('#tablebody').append(hex[6]);
                    $('#tablebody').append(hex[7]);
                    $('#tablebody').append(hex[8]);
                    $('#tablebody').append(hex[9]);
                    $('#tablebody').append(summary[0]);
                    $('#tablebody').append(summary[1]);
                    $('#tablebody').append(summary[2]);
                    $('#tablebody').append(summary[3]);
                    $('#tablebody').append(summary[4]);
                    $('#tablebody').append(summary[5]);
                    $('#tablebody').append(summary[6]);
                    $('#tablebody').append(summary[7]);
                    $('#tablebody').append(summary[8]);
                    $('#tablebody').append(summary[9]);
                }
            }else{
                $("#msg").text(req.responseText);
                alert(req.responseText);
            }
        }
    }
    function showprint() {
        window.print();
    }
    $(document).ready(function () {
        var dat = new Date();
        dat.setDate(dat.getDate() - 1);
        /*
        $('#month').val(dat.getMonth() + 1);
        $('#year').empty();
        for (var i = dat.getFullYear() - 2; i < dat.getFullYear()+3;i++) {
            var txt = '<option value="' + i + '">' + i + '</option>';
            $('#year').append(txt);
        }
        $('#year').val(dat.getFullYear());
        */
        $("#startdate").val(dateStr(new Date(dat.getFullYear(), dat.getMonth(),1)));
        $("#enddate").val(dateStr(new Date(dat.getFullYear(), dat.getMonth()+1, 0)));

        $('#inputpane').hide();
        $('#btnprint').hide();
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    });
</script>